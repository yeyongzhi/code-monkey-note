# 浏览器的工作原理

截至目前，用户常用的浏览器主要有：

- windows: Chrome、Edge、火狐Firefox
- macOS：safari

## 导航

浏览器最核心、基本的功能就是**访问网页资源。访问网页资源的方式有许多种，包含：

- 点击链接...
- 提交表单...
- 直接在地址栏输入网址：`www.baidu.com`访问
- ...

### 第一步：DNS查询（解析IP地址）

每一个网页由静态资源构成（html、css、js和其他类型的文件）。访问网页的过程就是发送给服务器一个请求，服务器将请求对应的网页的静态资源返回到客户端，客户端获取后进行渲染，看到了我们的页面。

但是，我们所熟知的网址（www.baidu.com等等），对于我们都很明确的知道这对应的是百度搜索引擎的网页，但是对计算机来说，它们**不识别域名**，而是识别IP地址。每一个域名对应着**一个唯一的互联网IP地址**。例如假设百度对应的IP地址为**1.2.3.4**，那么计算机就需要知道这个信息。

这一步就被称为**DNS查询（解析IP地址）**，用下图即可概括：

![DNS发起查询请求](./images/DNS1.png)

![DNS得到响应结果](./images/DNS2.png)

> DNS服务器告诉你某个域名对应的IP地址后，这个映射关系会被缓存一段时间。当我们下次访问同样的地址（例如www.baidu.com）的时候，就可以避免再重复DNS查询这一步骤，会加快我们的访问速度。
DNS解析记录会被**计算机、浏览器**等存储在设备当中（注册表等等...）。同时，DNS缓存的时间也不是固定的，根据**DNS服务器、操作系统或者浏览器**等各不相同。一般情况下为24小时左右。

### 第二步：TCP握手（三次查询）

在完成第一步DNS解析后，浏览器就知道了目标网页的IP地址。接下去就是准备进行通信，传输数据了。
TCP的三次握手可以概括为：

1. SYN
2. SYN-ACK
3. ACK

![第一次握手：SYN](./images/DNS1.png)

![第二次握手：SYN-ACK](./images/DNS2.png)

![第三次握手：ACK](./images/DNS1.png)

> **第一次握手：**
发送的**数据包（SYN包）**中的SYN位为1，表示第一次握手的状态。同时携带一个序列号*seq=x*，x是一个随机产生的数值。发送之后此时客户端会进入**SYN_SEND**的状态。等待着服务器的响应
**第二次握手：**
**服务端发送SYN+ACK包**。这个数据包中包含什么数据呢？服务器的一个序列号*seq=y*，同时对客户端的序列号进行了确认（返回*ack=x+1*）。这里的*+1*还表示服务端期望收到的下一个数据包的seq序列号。返回响应后，服务端进入SYN_REVE状态。
**第三次握手：**
客户端接收到服务端发送的SYN+ACK包后，会再次**向服务端发送一个ACK包**，作为一次**最终确认**。这个ack包的序列号即为第二步的*ack=x+1*。此时，客户端进入ESTABLISHED状态，TCP连接建立完成。

上面详细的介绍了三次握手中的数据包含义，序列号等信息，便于我们更加好理解这三次握手对应的的代号（SYN、SYN-ACK、ACK）

### 第三步：TLS协商（Https）

对于通过 HTTPS 建立的安全连接，需要进行另一次握手。**这种握手（TLS协商）**决定了哪个密码将被用于加密通信，验证服务器，并在开始实际的数据传输之前建立一个安全的连接。

> 通过Https建立的链接相对安全性更高，因此需要进行另一次的握手。

![另一次握手：TLS握手](./images/TLS.png)

在这一步骤中，客户端和服务端之间还交换了一些信息，其过程大致如下：

1. **客户端`hello`**：客户端向服务端发送一条消息，包括TLS版本和支持的密码套件（一串数组），以及一串随机字节称为**客户端随机数**。——总共发送三部分信息。
2. **服务端heelo、证书**：服务端返回一条信息，其中包括服务端的TLS证书版本、服务端选择的密码套件和**服务端随机数**。
3. **服务端发送自己的证书**：为了让客户端验证自己的身份，服务端还把自己的证书给发送了过去，证书包含了服务端的公钥。
4. **客户端验证服务器证书**：客户端验证服务端发来的证书（校验证书是否过期、是否有效...），验证通过后回根据服务端的公钥等秘钥生成一个*预主秘钥*。接着把这个*预主秘钥*发送回服务端。
5. 至此为止，客户端服务端均通过信息交换获取到了**客户端随机数**、**服务端随机数**以及**预主秘钥**。根据这三个信息来生成最终的**会话秘钥**。
6. 客户端此时会发送一个消息（Change Cipher Spec）、Finished消息通知服务端：后续我们之间的通信将采用**确定好的密码套件**、**会话秘钥**来进行加密通信。同时验证双方的加密，解密功能都正常OK。TLS握手正式结束。

紧接着双方就可以收发加密的https的请求和响应了。

## 获取数据

### HTTP 请求

在我们建立好TCP握手（或者TLS协商之后），我们就可以准备开始进行通信了。
首先，客户端会发送一个**HTTP GET**请求，请求页面的HTML文件。这一步使用的是**HTTP协议**。

![HTTP请求网页文件](./images/HTTP.png)

统一资源标识符（uniform resource identifier）的缩写是URI，用于识别互联网上的抽象或物理资源（例如网站或电子邮件等资源地址），也就是代表了HTTP 请求的目标。
一个URI通常是由以下几部分组成的：

1. 协议：访问资源所使用的协议，如http或https
2. 域名：标识服务器所在的地址（也就是IP地址）
3. 端口号：标识服务器上的端口号。默认情况下，HTTP使用80端口、HTTPS使用443端口
4. 路径：指定资源在服务器上的具体路径。
5. 查询参数：键值对的形式拼接在路径的后面，以?开始，通常用于GET请求。
6. 片段标识符：用于指定资源中的某个片段，不会被发送到服务器，例如#fragment

